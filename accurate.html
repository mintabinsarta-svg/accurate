<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CMMSC • Aplikasi Penagihan Internet BUMDes Cikahuripan</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --brand: 210 90% 52%; --brand-2: 265 90% 58%; }
    html, body { height: 100%; }
    body { font-family: 'Plus Jakarta Sans', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
    .bg-grid {
      background-image:
        radial-gradient(24rem 24rem at 80% -10%, hsl(var(--brand)/0.15), transparent 60%),
        radial-gradient(24rem 24rem at -10% 100%, hsl(var(--brand-2)/0.15), transparent 60%),
        linear-gradient(180deg, #0f172a 0%, #0b1220 100%);
      background-attachment: fixed;
    }
    .glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.07); border: 1px solid rgba(255,255,255,0.12); }
    .badge { border: 1px solid rgba(255,255,255,.18); background: rgba(255,255,255,.06); }
    .focus-ring:focus { outline: 3px solid hsl(var(--brand)/.5); outline-offset: 2px; }
    .hide-print { }
    @media print {
      .hide-print { display: none !important; }
      .print-area { background: white !important; color: black !important; }
    }
  </style>
</head>
<body class="bg-grid text-slate-100 antialiased">
  <header class="relative z-10 max-w-7xl mx-auto px-6 pt-8 hide-print">
    <div class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-sky-500 to-violet-600 grid place-items-center shadow-lg">
          <svg width="26" height="26" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M3 12c5-8 13-8 18 0" stroke="white" stroke-width="2" stroke-linecap="round"/>
            <path d="M6 12c3.2-5 8.8-5 12 0" stroke="white" stroke-width="2" stroke-linecap="round" opacity=".8"/>
            <circle cx="12" cy="12" r="2.5" fill="white"/>
          </svg>
        </div>
        <div>
          <h1 class="text-2xl md:text-3xl font-bold tracking-tight">CMMSC • Penagihan Internet</h1>
          <p class="text-slate-300/90 leading-tight">BUMDes Cikahuripan Makmur Mandiri Sejahtera, Cikahuripan</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="badge text-xs uppercase tracking-wide px-3 py-1 rounded-full">Panel Petugas</span>
        <button id="openHelp" class="text-slate-300 hover:text-white underline underline-offset-4">Bantuan</button>
      </div>
    </div>

    <!-- Navigation Tabs -->
    <nav class="mt-6">
      <div class="flex flex-wrap gap-2">
        <button data-tab="pelanggan" class="tab-btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">1. Input Pelanggan Baru</button>
        <button data-tab="pengaturan" class="tab-btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">2. Pengaturan Harga/Mbps</button>
        <button data-tab="tagihan" class="tab-btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">3. Tagihan Otomatis Bulanan</button>
        <button data-tab="wa" class="tab-btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">4. Kirim WhatsApp</button>
        <button data-tab="laporan" class="tab-btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">5. Laporan Pembayaran</button>
        <button data-tab="form" class="tab-btn px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15">6. Formulir Pendaftaran</button>
      </div>
    </nav>
  </header>

  <main class="relative z-10 max-w-7xl mx-auto px-6 pb-24">
    <!-- Pelanggan (Input & Import) -->
    <section id="tab-pelanggan" class="mt-6 grid lg:grid-cols-3 gap-6">
      <div class="glass rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-4">Input Pelanggan Baru</h2>
        <form id="pelangganForm" class="space-y-4">
          <label class="block">
            <span class="text-sm text-slate-300">Nama</span>
            <input id="p_nama" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="Nama pelanggan" required>
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm text-slate-300">Nomor WhatsApp</span>
              <input id="p_wa" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="62XXXXXXXXXXX" required>
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">ID Pelanggan (opsional)</span>
              <input id="p_idpel" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="ID unik (opsional)">
            </label>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm text-slate-300">Paket</span>
              <select id="p_paket" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
                <option value="BUMDes 10 Mbps">BUMDes 10 Mbps</option>
                <option value="Basic 10 Mbps">Basic 10 Mbps</option>
                <option value="Family 20 Mbps">Family 20 Mbps</option>
                <option value="Pro 50 Mbps">Pro 50 Mbps</option>
                <option value="Custom">Custom (isi sendiri)</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">Jika Custom, nama paket</span>
              <input id="p_paket_custom" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="Contoh: UMKM 15 Mbps">
            </label>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <label class="block">
              <span class="text-sm text-slate-300">Mbps</span>
              <input id="p_mbps" type="number" min="1" step="1" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="10" required>
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">Harga Langganan</span>
              <input id="p_harga" type="number" min="0" step="1000" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="150000" required>
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">Tanggal Aktif</span>
              <input id="p_tgl_aktif" type="date" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" required>
            </label>
          </div>
          <label class="block">
            <span class="text-sm text-slate-300">Alamat (opsional)</span>
            <input id="p_alamat" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="Alamat pelanggan">
          </label>
          <div class="flex gap-3 pt-2">
            <button type="submit" class="px-4 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-semibold">Simpan Pelanggan</button>
            <button type="button" id="resetPelanggan" class="px-4 py-3 rounded-xl bg-slate-700/70 hover:bg-slate-600">Reset</button>
          </div>
        </form>
      </div>

      <div class="glass rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-3">Impor Data Pelanggan (CSV)</h2>
        <p class="text-sm text-slate-300 mb-3">Format kolom yang didukung: nama, wa, idpel, paket, mbps, harga, tglAktif, alamat</p>
        <div class="space-y-3">
          <button id="importPelangganBtn" class="w-full px-4 py-3 rounded-xl bg-amber-600 hover:bg-amber-700 font-semibold">Pilih File CSV</button>
          <input type="file" id="pelangganFile" accept=".csv" class="hidden">
          <button id="exportPelangganBtn" class="w-full px-4 py-3 rounded-xl bg-sky-600 hover:bg-sky-700 font-semibold">Unduh Pelanggan (CSV)</button>
          <button id="clearPelangganBtn" class="w-full px-4 py-3 rounded-xl bg-rose-600 hover:bg-rose-700 font-semibold">Bersihkan Semua Pelanggan</button>
        </div>
        <p class="text-xs text-slate-300/80 mt-3">Data hanya tersimpan di perangkat ini.</p>
      </div>

      <div class="glass rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-3">Daftar Pelanggan</h2>
        <input id="searchPelanggan" placeholder="Cari nama/WA/ID..." class="focus-ring w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2.5 mb-3">
        <div class="max-h-80 overflow-auto rounded-xl border border-white/10">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-slate-200 sticky top-0">
              <tr>
                <th class="text-left font-semibold px-4 py-3">Nama</th>
                <th class="text-left font-semibold px-4 py-3">WA</th>
                <th class="text-left font-semibold px-4 py-3">Paket</th>
                <th class="text-right font-semibold px-4 py-3">Harga</th>
                <th class="text-left font-semibold px-4 py-3">Aktif</th>
                <th class="text-right font-semibold px-4 py-3">Aksi</th>
              </tr>
            </thead>
            <tbody id="pelangganBody" class="divide-y divide-white/10"></tbody>
          </table>
          <div id="pelangganKosong" class="p-6 text-center text-slate-300/80">Belum ada pelanggan.</div>
        </div>
      </div>
    </section>

    <!-- Pengaturan Harga/Mbps dan Tanggal Penagihan -->
    <section id="tab-pengaturan" class="mt-6 grid lg:grid-cols-2 gap-6 hidden">
      <div class="glass rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-4">Metode Harga</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-slate-300 text-sm">Metode Perhitungan</label>
            <div class="mt-2 space-y-2">
              <label class="flex items-center gap-3">
                <input type="radio" name="priceMode" value="perPackage" class="accent-indigo-500"> <span>Per Paket</span>
              </label>
              <label class="flex items-center gap-3">
                <input type="radio" name="priceMode" value="perMbps" class="accent-indigo-500"> <span>Per Mbps (Mbps x Harga/Mbps)</span>
              </label>
            </div>
          </div>

          <div>
            <label class="block text-slate-300 text-sm">Harga/Mbps</label>
            <input id="pricePerMbps" type="number" min="0" step="500" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="contoh: 15000">
          </div>

          <div>
            <label class="block text-slate-300 text-sm">Harga Per Paket (termasuk Custom)</label>
            <div class="grid md:grid-cols-2 gap-3 mt-2" id="packageList">
              <!-- package editable items inserted -->
            </div>
            <div class="flex gap-2 mt-3">
              <input id="newPkgName" placeholder="Nama paket (mis. UMKM 15 Mbps)" class="focus-ring flex-1 rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2.5">
              <input id="newPkgPrice" type="number" min="0" step="1000" placeholder="Harga" class="focus-ring w-40 rounded-xl bg-slate-900/60 border border-white/10 px-4 py-2.5">
              <button id="addPkgBtn" class="px-4 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-semibold">Tambah</button>
            </div>
          </div>
        </div>
        <div class="mt-5 flex justify-end">
          <button id="saveSettings" class="px-5 py-3 rounded-xl bg-indigo-600 hover:bg-indigo-700 font-semibold">Simpan Pengaturan</button>
        </div>
      </div>

      <div class="glass rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-4">Penjadwalan Tagihan</h2>
        <div class="space-y-4">
          <div>
            <label class="block text-slate-300 text-sm">Metode Penagihan Bulanan</label>
            <div class="mt-2 space-y-2">
              <label class="flex items-center gap-3">
                <input type="radio" name="billMode" value="byAktif" class="accent-indigo-500"> <span>Berdasarkan Tanggal Aktif Pelanggan</span>
              </label>
              <label class="flex items-center gap-3">
                <input type="radio" name="billMode" value="byAdminDate" class="accent-indigo-500"> <span>Tanggal Penagihan Ditentukan Admin</span>
              </label>
            </div>
          </div>
          <div>
            <label class="block text-slate-300 text-sm">Tanggal Penagihan Admin</label>
            <input id="adminBillDay" type="number" min="1" max="28" class="focus-ring mt-1 w-40 rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="mis. 5">
            <p class="text-xs text-slate-400 mt-1">Aman hingga 28 agar cocok di semua bulan.</p>
          </div>
          <div>
            <label class="block text-slate-300 text-sm">Template Pesan WhatsApp</label>
            <textarea id="waTemplate" rows="5" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="Gunakan {nama}, {paket}, {periode}, {total}, {jatuhTempo}, {idpel}"></textarea>
            <p class="text-xs text-slate-400 mt-1">Contoh: Halo {nama}, ini tagihan internet CMMSC periode {periode} ...</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Tagihan Otomatis -->
    <section id="tab-tagihan" class="mt-6 grid lg:grid-cols-1 gap-6 hidden">
      <div class="glass rounded-2xl p-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
          <h2 class="text-lg font-semibold">Daftar Tagihan Bulanan</h2>
          <div class="flex flex-wrap gap-2">
            <input id="periodInput" type="month" class="focus-ring rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2.5">
            <button id="genBillsBtn" class="px-4 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-semibold">Generate Tagihan Bulan Ini</button>
            <button id="exportBillsBtn" class="px-4 py-2.5 rounded-xl bg-sky-600 hover:bg-sky-700 font-semibold">Unduh Tagihan (CSV)</button>
          </div>
        </div>

        <div class="mt-4 overflow-auto rounded-xl border border-white/10">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-slate-200">
              <tr>
                <th class="text-left font-semibold px-4 py-3">Pelanggan</th>
                <th class="text-left font-semibold px-4 py-3">Periode</th>
                <th class="text-left font-semibold px-4 py-3">Paket</th>
                <th class="text-right font-semibold px-4 py-3">Total</th>
                <th class="text-center font-semibold px-4 py-3">Status</th>
                <th class="text-right font-semibold px-4 py-3">Aksi</th>
              </tr>
            </thead>
            <tbody id="billsBody" class="divide-y divide-white/10"></tbody>
          </table>
          <div id="billsEmpty" class="p-6 text-center text-slate-300/80">Belum ada tagihan. Klik Generate Tagihan Bulan Ini.</div>
        </div>
      </div>
    </section>

    <!-- Kirim WhatsApp -->
    <section id="tab-wa" class="mt-6 grid lg:grid-cols-1 gap-6 hidden">
      <div class="glass rounded-2xl p-6">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3">
          <h2 class="text-lg font-semibold">Kirim WhatsApp</h2>
          <div class="flex gap-2">
            <select id="waPeriod" class="focus-ring rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2.5"></select>
            <button id="sendAllBtn" class="px-4 py-2.5 rounded-xl bg-indigo-600 hover:bg-indigo-700 font-semibold">Kirim WA ke Semua</button>
          </div>
        </div>
        <div class="mt-3 text-sm text-slate-300">Pilih periode lalu kirim ke pelanggan yang memiliki tagihan periode tersebut.</div>
        <div class="mt-4 overflow-auto rounded-xl border border-white/10">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-slate-200">
              <tr>
                <th class="text-left font-semibold px-4 py-3">Pelanggan</th>
                <th class="text-left font-semibold px-4 py-3">Periode</th>
                <th class="text-right font-semibold px-4 py-3">Total</th>
                <th class="text-center font-semibold px-4 py-3">Status</th>
                <th class="text-right font-semibold px-4 py-3">Aksi</th>
              </tr>
            </thead>
            <tbody id="waBody" class="divide-y divide-white/10"></tbody>
          </table>
          <div id="waEmpty" class="p-6 text-center text-slate-300/80">Belum ada tagihan untuk periode ini.</div>
        </div>
      </div>
    </section>

    <!-- Laporan Pembayaran -->
    <section id="tab-laporan" class="mt-6 grid lg:grid-cols-1 gap-6 hidden">
      <div class="glass rounded-2xl p-6 print-area">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-3 hide-print">
          <h2 class="text-lg font-semibold">Laporan Pembayaran</h2>
          <div class="flex flex-wrap gap-2">
            <input id="lapPeriod" type="month" class="focus-ring rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2.5">
            <select id="lapStatus" class="focus-ring rounded-xl bg-slate-900/60 border border-white/10 px-3 py-2.5">
              <option value="all">Semua</option>
              <option value="paid">Sudah Bayar</option>
              <option value="unpaid">Belum Bayar</option>
            </select>
            <button id="printBtn" class="px-4 py-2.5 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-semibold">Cetak / Simpan PDF</button>
            <button id="exportReportBtn" class="px-4 py-2.5 rounded-xl bg-sky-600 hover:bg-sky-700 font-semibold">Unduh Laporan (CSV)</button>
          </div>
        </div>

        <div class="mt-4 overflow-auto rounded-xl border border-white/10">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-slate-200">
              <tr>
                <th class="text-left font-semibold px-4 py-3">Tanggal</th>
                <th class="text-left font-semibold px-4 py-3">Pelanggan</th>
                <th class="text-left font-semibold px-4 py-3">Periode</th>
                <th class="text-right font-semibold px-4 py-3">Total</th>
                <th class="text-center font-semibold px-4 py-3">Status</th>
              </tr>
            </thead>
            <tbody id="reportBody" class="divide-y divide-white/10"></tbody>
          </table>
          <div id="reportEmpty" class="p-6 text-center text-slate-300/80">Tidak ada data.</div>
        </div>
      </div>
    </section>

    <!-- Formulir Pendaftaran (Public) -->
    <section id="tab-form" class="mt-6 grid lg:grid-cols-2 gap-6 hidden">
      <div class="glass rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-4">Formulir Pendaftaran Pelanggan Baru (Demo)</h2>
        <p class="text-sm text-amber-300 mb-4">Demo: formulir ini menyimpan data ke perangkat Anda. Untuk pendaftaran online sungguhan (kirim email/server) belum didukung oleh Canva Code.</p>
        <form id="publicForm" class="space-y-4">
          <label class="block">
            <span class="text-sm text-slate-300">Nama Lengkap</span>
            <input id="f_nama" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" required>
          </label>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm text-slate-300">Nomor WhatsApp</span>
              <input id="f_wa" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" required>
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">Alamat</span>
              <input id="f_alamat" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
            </label>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <label class="block">
              <span class="text-sm text-slate-300">Paket</span>
              <select id="f_paket" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3">
                <option value="BUMDes 10 Mbps">BUMDes 10 Mbps</option>
                <option value="Basic 10 Mbps">Basic 10 Mbps</option>
                <option value="Family 20 Mbps">Family 20 Mbps</option>
                <option value="Pro 50 Mbps">Pro 50 Mbps</option>
                <option value="Custom">Custom</option>
              </select>
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">Jika Custom</span>
              <input id="f_paket_custom" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" placeholder="Isi nama paket">
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">Tanggal Aktif</span>
              <input id="f_tgl_aktif" type="date" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" required>
            </label>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <label class="block">
              <span class="text-sm text-slate-300">Mbps</span>
              <input id="f_mbps" type="number" min="1" step="1" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" required>
            </label>
            <label class="block">
              <span class="text-sm text-slate-300">Harga Perkiraan</span>
              <input id="f_harga" type="number" min="0" step="1000" class="focus-ring mt-1 w-full rounded-xl bg-slate-900/60 border border-white/10 px-4 py-3" required>
            </label>
          </div>
          <button class="px-5 py-3 rounded-xl bg-emerald-600 hover:bg-emerald-700 font-semibold">Kirim Pendaftaran</button>
        </form>
      </div>

      <div class="glass rounded-2xl p-6">
        <h2 class="text-lg font-semibold mb-4">Pendaftaran Masuk</h2>
        <div class="max-h-96 overflow-auto rounded-xl border border-white/10">
          <table class="min-w-full text-sm">
            <thead class="bg-white/5 text-slate-200">
              <tr>
                <th class="text-left font-semibold px-4 py-3">Waktu</th>
                <th class="text-left font-semibold px-4 py-3">Nama</th>
                <th class="text-left font-semibold px-4 py-3">WA</th>
                <th class="text-left font-semibold px-4 py-3">Paket</th>
              </tr>
            </thead>
            <tbody id="pendaftaranBody" class="divide-y divide-white/10"></tbody>
          </table>
          <div id="pendaftaranKosong" class="p-6 text-center text-slate-300/80">Belum ada pengajuan.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Bantuan Modal -->
  <div id="helpModal" class="fixed inset-0 hidden items-center justify-center z-50">
    <div class="absolute inset-0 bg-black/60"></div>
    <div class="relative glass rounded-2xl p-6 max-w-lg mx-4">
      <div class="flex items-start justify-between gap-4">
        <div>
          <h3 class="text-xl font-bold">Cara Pakai Singkat</h3>
          <ol class="mt-3 space-y-2 text-slate-200/90 text-sm">
            <li>1. Tambah pelanggan di menu 1 atau impor CSV.</li>
            <li>2. Atur harga & metode tanggal di menu 2.</li>
            <li>3. Generate tagihan bulanan di menu 3.</li>
            <li>4. Kirim WhatsApp massal di menu 4.</li>
            <li>5. Cetak laporan di menu 5.</li>
            <li>6. Form pendaftaran tersedia sebagai demo lokal.</li>
          </ol>
        </div>
        <button id="closeHelp" class="p-2 rounded-lg bg-slate-800/80 hover:bg-slate-700">?</button>
      </div>
    </div>
  </div>

  <footer class="relative z-10 max-w-7xl mx-auto px-6 mt-8 hide-print">
    <div class="text-center text-slate-400 text-sm">
      © <span id="year"></span> BUMDes Cikahuripan Makmur Mandiri Sejahtera (CMMSC). Semua hak dilindungi.
    </div>
  </footer>

  <script>
    // Utilities
    const byId = (id) => document.getElementById(id);
    const qsa = (s, el=document) => Array.from(el.querySelectorAll(s));
    const rupiah = n => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(n || 0);
    const todayMonth = () => {
      const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    };
    const fmtDate = (dStr) => dStr ? new Date(dStr).toLocaleDateString('id-ID') : '-';
    const normPhone = (input) => {
      const digits = (input||'').replace(/\D/g,'');
      if (digits.startsWith('62')) return digits;
      if (digits.startsWith('0')) return '62' + digits.slice(1);
      return digits;
    };

    // Storage keys
    const LS_PELANGGAN = 'cmmsc_pelanggan_v1';
    const LS_BILLS = 'cmmsc_bills_v2';
    const LS_SETTINGS = 'cmmsc_settings_v2';
    const LS_FORMS = 'cmmsc_forms_v1';

    // State
    let pelanggan = load(LS_PELANGGAN, []);
    let bills = load(LS_BILLS, []);
    let settings = load(LS_SETTINGS, {
      priceMode: 'perPackage',
      pricePerMbps: 15000,
      packagePrices: {
        'BUMDes 10 Mbps': 150000,
        'Basic 10 Mbps': 150000,
        'Family 20 Mbps': 200000,
        'Pro 50 Mbps': 300000
      },
      billMode: 'byAktif', // 'byAktif' or 'byAdminDate'
      adminBillDay: 5,
      waTemplate: [
        'Halo {nama},',
        'Ini tagihan internet CMMSC untuk {periode}.',
        'Paket: {paket}.',
        'Total: {total}.',
        'Jatuh tempo: {jatuhTempo}.',
        '{idpel}',
        'Terima kasih. BUMDes Cikahuripan.'
      ].join('\n')
    });
    let forms = load(LS_FORMS, []);

    function load(key, fallback) {
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch { return fallback; }
    }
    function save(key, data) { localStorage.setItem(key, JSON.stringify(data)); }

    // Navigation
    const tabs = {
      pelanggan: byId('tab-pelanggan'),
      pengaturan: byId('tab-pengaturan'),
      tagihan: byId('tab-tagihan'),
      wa: byId('tab-wa'),
      laporan: byId('tab-laporan'),
      form: byId('tab-form'),
    };
    const tabButtons = qsa('.tab-btn');
    function showTab(name) {
      Object.entries(tabs).forEach(([k, el]) => el.classList.toggle('hidden', k !== name));
      tabButtons.forEach(btn => {
        const active = btn.getAttribute('data-tab') === name;
        btn.className = 'tab-btn px-4 py-2 rounded-xl ' + (active ? 'bg-indigo-600' : 'bg-white/10 hover:bg-white/15');
      });
    }
    // default tab
    showTab('pelanggan');
    tabButtons.forEach(btn => btn.addEventListener('click', () => showTab(btn.getAttribute('data-tab'))));

    // Help modal
    const helpModal = byId('helpModal');
    byId('openHelp').addEventListener('click', () => { helpModal.classList.remove('hidden'); helpModal.classList.add('flex'); });
    byId('closeHelp').addEventListener('click', () => { helpModal.classList.add('hidden'); helpModal.classList.remove('flex'); });
    helpModal.addEventListener('click', (e) => { if (e.target === helpModal) byId('closeHelp').click(); });

    // Year
    byId('year').textContent = new Date().getFullYear();

    // Populate settings UI
    function renderSettingsUI() {
      // price mode
      qsa('input[name="priceMode"]').forEach(r => r.checked = (r.value === settings.priceMode));
      byId('pricePerMbps').value = settings.pricePerMbps || '';
      // bill mode
      qsa('input[name="billMode"]').forEach(r => r.checked = (r.value === settings.billMode));
      byId('adminBillDay').value = settings.adminBillDay || '';
      byId('waTemplate').value = settings.waTemplate || '';

      // package editable list
      const cont = byId('packageList');
      cont.innerHTML = '';
      Object.entries(settings.packagePrices).forEach(([name, price]) => cont.appendChild(pkgItem(name, price)));
    }
    function pkgItem(name, price) {
      const wrap = document.createElement('div');
      wrap.className = 'rounded-xl bg-slate-900/50 border border-white/10 p-3 flex items-center gap-2';
      wrap.innerHTML = `
        <input value="${name}" class="pkg-name flex-1 rounded-lg bg-slate-900/60 border border-white/10 px-3 py-2">
        <input value="${price}" type="number" min="0" step="1000" class="pkg-price w-32 rounded-lg bg-slate-900/60 border border-white/10 px-3 py-2">
        <button class="delPkg px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-700 text-sm">Hapus</button>
      `;
      wrap.querySelector('.delPkg').addEventListener('click', () => { wrap.remove(); });
      return wrap;
    }
    renderSettingsUI();

    byId('addPkgBtn').addEventListener('click', () => {
      const name = byId('newPkgName').value.trim();
      const price = Number(byId('newPkgPrice').value || 0);
      if (!name || !price) return alert('Isi nama paket dan harga.');
      byId('packageList').appendChild(pkgItem(name, price));
      byId('newPkgName').value = ''; byId('newPkgPrice').value = '';
    });

    byId('saveSettings').addEventListener('click', () => {
      const mode = document.querySelector('input[name="priceMode"]:checked')?.value || 'perPackage';
      const billMode = document.querySelector('input[name="billMode"]:checked')?.value || 'byAktif';
      const perMbps = Number(byId('pricePerMbps').value || settings.pricePerMbps || 0);
      const adminDay = Number(byId('adminBillDay').value || settings.adminBillDay || 5);
      const tmpl = byId('waTemplate').value.trim() || settings.waTemplate;
      const list = byId('packageList');
      const newMap = {};
      qsa('.pkg-name', list).forEach((n,i) => {
        const name = n.value.trim();
        const price = Number(qsa('.pkg-price', list)[i].value || 0);
        if (name) newMap[name] = price;
      });
      settings = { ...settings, priceMode: mode, billMode, pricePerMbps: perMbps, adminBillDay: adminDay, packagePrices: newMap, waTemplate: tmpl };
      save(LS_SETTINGS, settings);
      alert('Pengaturan disimpan.');
    });

    // Harga otomatis untuk pelanggan form
    function calcHarga(paketLabel, mbps) {
      if (settings.priceMode === 'perPackage') {
        // gunakan nama paket jika ada, jika "Custom" gunakan map jika tersedia dengan nama custom, kalau tidak fallback ke perMbps
        if (paketLabel && settings.packagePrices[paketLabel] != null) return settings.packagePrices[paketLabel];
        // fallback ke per Mbps
      }
      return (Number(mbps||0) * Number(settings.pricePerMbps||0)) || 0;
    }

    const p_paket = byId('p_paket');
    const p_paket_custom = byId('p_paket_custom');
    const p_mbps = byId('p_mbps');
    const p_harga = byId('p_harga');
    function syncHargaInput() {
      const label = p_paket.value === 'Custom' ? (p_paket_custom.value.trim() || 'Custom') : p_paket.value;
      p_harga.value = calcHarga(label, p_mbps.value);
    }
    p_paket.addEventListener('change', syncHargaInput);
    p_mbps.addEventListener('input', syncHargaInput);
    p_paket_custom.addEventListener('input', syncHargaInput);

    // Pelanggan form submit
    byId('pelangganForm').addEventListener('submit', (e) => {
      e.preventDefault();
      const item = {
        id: crypto.randomUUID(),
        nama: byId('p_nama').value.trim(),
        wa: normPhone(byId('p_wa').value),
        idpel: byId('p_idpel').value.trim(),
        paket: p_paket.value === 'Custom' ? (byId('p_paket_custom').value.trim() || 'Custom') : p_paket.value,
        mbps: Number(byId('p_mbps').value || 0),
        harga: Number(byId('p_harga').value || 0),
        tglAktif: byId('p_tgl_aktif').value,
        alamat: byId('p_alamat').value.trim(),
        createdAt: new Date().toISOString()
      };
      if (!item.nama || !item.wa || !item.mbps || !item.harga || !item.tglAktif) return alert('Lengkapi data wajib.');
      pelanggan.push(item); save(LS_PELANGGAN, pelanggan);
      renderPelanggan(); e.target.reset(); syncHargaInput();
    });
    byId('resetPelanggan').addEventListener('click', () => { byId('pelangganForm').reset(); syncHargaInput(); });

    // Pelanggan table
    const pelangganBody = byId('pelangganBody');
    const pelangganKosong = byId('pelangganKosong');
    const searchPelanggan = byId('searchPelanggan');
    function renderPelanggan() {
      const q = (searchPelanggan.value||'').toLowerCase();
      const data = pelanggan.filter(p => [p.nama, p.wa, p.idpel].join(' ').toLowerCase().includes(q));
      pelangganBody.innerHTML = '';
      pelangganKosong.style.display = data.length ? 'none' : 'block';
      data.forEach(p => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5';
        tr.innerHTML = `
          <td class="px-4 py-3 font-semibold">${escapeHTML(p.nama)}</td>
          <td class="px-4 py-3">${p.wa}</td>
          <td class="px-4 py-3">${escapeHTML(p.paket)} • ${p.mbps} Mbps</td>
          <td class="px-4 py-3 text-right">${rupiah(p.harga)}</td>
          <td class="px-4 py-3">${fmtDate(p.tglAktif)}</td>
          <td class="px-4 py-3 text-right">
            <div class="flex justify-end gap-2">
              <button data-act="wa" data-id="${p.id}" class="px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-xs">Kirim WA</button>
              <button data-act="edit" data-id="${p.id}" class="px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-xs">Ubah</button>
              <button data-act="del" data-id="${p.id}" class="px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-700 text-xs">Hapus</button>
            </div>
          </td>
        `;
        pelangganBody.appendChild(tr);
      });
    }
    function escapeHTML(s='') { return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
    searchPelanggan.addEventListener('input', renderPelanggan);

    pelangganBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      const p = pelanggan.find(x => x.id === id); if (!p) return;
      const act = btn.getAttribute('data-act');
      if (act === 'wa') {
        const msg = `Halo ${p.nama}, data pelanggan Anda terdaftar paket ${p.paket} ${p.mbps} Mbps. Terima kasih.`;
        window.open(`https://wa.me/${encodeURIComponent(p.wa)}?text=${encodeURIComponent(msg)}`, '_blank');
      }
      if (act === 'edit') {
        byId('p_nama').value = p.nama;
        byId('p_wa').value = p.wa;
        byId('p_idpel').value = p.idpel || '';
        byId('p_mbps').value = p.mbps || 0;
        byId('p_harga').value = p.harga || 0;
        byId('p_tgl_aktif').value = p.tglAktif || '';
        byId('p_alamat').value = p.alamat || '';
        // paket
        const isCustom = !(p.paket in settings.packagePrices);
        byId('p_paket').value = isCustom ? 'Custom' : p.paket;
        byId('p_paket_custom').value = isCustom ? p.paket : '';
        // remove and let save as new replace
        pelanggan = pelanggan.filter(x => x.id !== id); save(LS_PELANGGAN, pelanggan); renderPelanggan();
      }
      if (act === 'del') {
        if (confirm('Hapus pelanggan ini?')) {
          pelanggan = pelanggan.filter(x => x.id !== id); save(LS_PELANGGAN, pelanggan); renderPelanggan();
        }
      }
    });

    // Import/Export pelanggan
    byId('importPelangganBtn').addEventListener('click', () => byId('pelangganFile').click());
    byId('pelangganFile').addEventListener('change', async (e) => {
      const file = e.target.files[0]; if (!file) return;
      const text = await file.text();
      const rows = parseCSV(text);
      if (!rows.length) return alert('File kosong/format tidak cocok.');
      // header normalize
      const norm = k => (k||'').trim();
      const mapRow = r => ({
        id: crypto.randomUUID(),
        nama: norm(r.nama),
        wa: normPhone(r.wa),
        idpel: norm(r.idpel),
        paket: norm(r.paket) || 'BUMDes 10 Mbps',
        mbps: Number(r.mbps || 10),
        harga: Number(r.harga || calcHarga(norm(r.paket), Number(r.mbps||10))),
        tglAktif: r.tglAktif || new Date().toISOString().slice(0,10),
        alamat: norm(r.alamat),
        createdAt: new Date().toISOString()
      });
      const items = rows.map(mapRow);
      pelanggan = pelanggan.concat(items); save(LS_PELANGGAN, pelanggan); renderPelanggan();
      e.target.value = '';
      alert('Impor pelanggan selesai.');
    });
    byId('exportPelangganBtn').addEventListener('click', () => {
      if (!pelanggan.length) return alert('Tidak ada data.');
      const header = ['nama','wa','idpel','paket','mbps','harga','tglAktif','alamat'];
      const csv = [header.join(',')].concat(pelanggan.map(p => header.map(h => csvCell(p[h])).join(','))).join('\n');
      downloadCSV(csv, 'cmmsc_pelanggan.csv');
    });
    byId('clearPelangganBtn').addEventListener('click', () => {
      if (confirm('Hapus semua pelanggan?')) { pelanggan = []; save(LS_PELANGGAN, pelanggan); renderPelanggan(); }
    });

    // Tagihan: generate berdasarkan periode
    const billsBody = byId('billsBody');
    const billsEmpty = byId('billsEmpty');
    byId('periodInput').value = todayMonth();

    function generateBillsForPeriod(period) {
      const [Y,M] = period.split('-').map(Number);
      const createdAt = new Date().toISOString();
      // Determine due date: 10 days after billing day
      const baseDay = settings.billMode === 'byAdminDate' ? (settings.adminBillDay || 5) : null;

      const newBills = [];
      pelanggan.forEach(p => {
        const aktif = new Date(p.tglAktif);
        const aktifPeriod = `${aktif.getFullYear()}-${String(aktif.getMonth()+1).padStart(2,'0')}`;
        // only bill if active period is <= selected period
        if (aktifPeriod > period) return;

        // compute billing day
        let billDay = baseDay;
        if (settings.billMode === 'byAktif') {
          billDay = Math.min(28, new Date(p.tglAktif).getDate());
        }
        const dueDate = new Date(Y, M-1, Math.min(28, billDay + 7)); // 7 days after
        const paketLabel = p.paket;
        const total = calcHarga(paketLabel, p.mbps);

        const record = {
          id: crypto.randomUUID(),
          pelangganId: p.id,
          nama: p.nama,
          wa: p.wa,
          idpel: p.idpel || '',
          paket: paketLabel,
          mbps: p.mbps,
          periode: period,
          total,
          biaya: total,
          denda: 0,
          diskon: 0,
          jatuhTempo: dueDate.toISOString().slice(0,10),
          status: 'unpaid',
          createdAt
        };
        // avoid duplicates
        const exists = bills.some(b => b.pelangganId === record.pelangganId && b.periode === record.periode);
        if (!exists) newBills.push(record);
      });

      if (!newBills.length) { alert('Tidak ada tagihan baru untuk periode ini atau sudah dibuat.'); return; }
      bills = bills.concat(newBills); save(LS_BILLS, bills);
      renderBills(); renderWAList(); renderReport();
      alert(`Berhasil membuat ${newBills.length} tagihan.`);
    }

    function renderBills() {
      billsBody.innerHTML = '';
      const per = byId('periodInput').value;
      const data = bills.filter(b => b.periode === per);
      billsEmpty.style.display = data.length ? 'none' : 'block';
      data.forEach(b => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5';
        tr.innerHTML = `
          <td class="px-4 py-3">
            <div class="font-semibold">${escapeHTML(b.nama)}</div>
            <div class="text-slate-300 text-xs">WA: ${b.wa}${b.idpel ? ' • ID: '+escapeHTML(b.idpel):''}</div>
          </td>
          <td class="px-4 py-3">${b.periode.split('-').reverse().join('/')}</td>
          <td class="px-4 py-3">${escapeHTML(b.paket)} • ${b.mbps} Mbps</td>
          <td class="px-4 py-3 text-right">${rupiah(b.total)}</td>
          <td class="px-4 py-3 text-center">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${b.status==='paid'?'bg-emerald-500/20 text-emerald-300':'bg-amber-500/20 text-amber-300'}">
              ${b.status==='paid'?'Sudah Bayar':'Belum Bayar'}
            </span>
          </td>
          <td class="px-4 py-3 text-right">
            <div class="flex justify-end gap-2">
              <button data-act="wa" data-id="${b.id}" class="px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-xs">Kirim WA</button>
              <button data-act="toggle" data-id="${b.id}" class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-xs">${b.status==='paid'?'Tandai Belum':'Tandai Bayar'}</button>
              <button data-act="del" data-id="${b.id}" class="px-3 py-2 rounded-lg bg-rose-600 hover:bg-rose-700 text-xs">Hapus</button>
            </div>
          </td>
        `;
        billsBody.appendChild(tr);
      });
      // update WA period dropdown
      fillWaPeriodOptions();
    }

    billsBody.addEventListener('click', (e) => {
      const btn = e.target.closest('button'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      const idx = bills.findIndex(b => b.id === id); if (idx === -1) return;
      if (act === 'wa') {
        openWA(bills[idx]);
      }
      if (act === 'toggle') {
        bills[idx].status = bills[idx].status === 'paid' ? 'unpaid' : 'paid';
        save(LS_BILLS, bills); renderBills(); renderReport(); renderWAList();
      }
      if (act === 'del') {
        if (confirm('Hapus tagihan ini?')) {
          bills.splice(idx,1); save(LS_BILLS, bills); renderBills(); renderWAList(); renderReport();
        }
      }
    });

    byId('genBillsBtn').addEventListener('click', () => {
      const per = byId('periodInput').value || todayMonth();
      generateBillsForPeriod(per);
    });
    byId('exportBillsBtn').addEventListener('click', () => {
      const header = ['nama','wa','idpel','paket','mbps','periode','total','status','jatuhTempo','createdAt'];
      const csv = [header.join(',')].concat(bills.map(b => header.map(h => csvCell(b[h])).join(','))).join('\n');
      downloadCSV(csv, 'cmmsc_tagihan.csv');
    });

    // WhatsApp messaging
    const waTemplateVars = (b) => {
      const map = {
        '{nama}': b.nama,
        '{paket}': `${b.paket} ${b.mbps} Mbps`,
        '{periode}': b.periode.split('-').reverse().join('/'),
        '{total}': rupiah(b.total),
        '{jatuhTempo}': fmtDate(b.jatuhTempo),
        '{idpel}': b.idpel ? `ID Pelanggan: ${b.idpel}.` : ''
      };
      let text = settings.waTemplate;
      Object.entries(map).forEach(([k,v]) => text = text.replaceAll(k, v));
      return text;
    };
    function openWA(bill) {
      const url = `https://wa.me/${encodeURIComponent(normPhone(bill.wa))}?text=${encodeURIComponent(waTemplateVars(bill))}`;
      window.open(url, '_blank');
    }
    const waPeriod = byId('waPeriod');
    function fillWaPeriodOptions() {
      const uniq = Array.from(new Set(bills.map(b => b.periode))).sort().reverse();
      waPeriod.innerHTML = uniq.map(p => `<option value="${p}">${p.split('-').reverse().join('/')}</option>`).join('');
      renderWAList();
    }
    const waBody = byId('waBody');
    const waEmpty = byId('waEmpty');
    function renderWAList() {
      const per = waPeriod.value || '';
      const data = bills.filter(b => b.periode === per);
      waBody.innerHTML = '';
      waEmpty.style.display = data.length ? 'none' : 'block';
      data.forEach(b => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5';
        tr.innerHTML = `
          <td class="px-4 py-3 font-semibold">${escapeHTML(b.nama)}</td>
          <td class="px-4 py-3">${b.periode.split('-').reverse().join('/')}</td>
          <td class="px-4 py-3 text-right">${rupiah(b.total)}</td>
          <td class="px-4 py-3 text-center">
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${b.status==='paid'?'bg-emerald-500/20 text-emerald-300':'bg-amber-500/20 text-amber-300'}">
              ${b.status==='paid'?'Sudah Bayar':'Belum Bayar'}
            </span>
          </td>
          <td class="px-4 py-3 text-right">
            <button data-id="${b.id}" class="wa-single px-3 py-2 rounded-lg bg-sky-600 hover:bg-sky-700 text-xs">Kirim WA</button>
          </td>
        `;
        waBody.appendChild(tr);
      });
    }
    waBody.addEventListener('click', (e) => {
      const btn = e.target.closest('.wa-single'); if (!btn) return;
      const id = btn.getAttribute('data-id');
      const b = bills.find(x => x.id === id); if (!b) return;
      openWA(b);
    });
    byId('sendAllBtn').addEventListener('click', () => {
      const per = waPeriod.value; if (!per) return;
      const data = bills.filter(b => b.periode === per);
      if (!data.length) return alert('Tidak ada tagihan untuk periode ini.');
      // Membuka banyak tab bisa dibatasi oleh browser, jadi kita kirim satu per satu dengan jeda singkat
      let i = 0;
      const tick = () => {
        if (i >= data.length) return;
        openWA(data[i]); i++; setTimeout(tick, 400);
      };
      tick();
    });
    waPeriod.addEventListener('change', renderWAList);

    // Laporan
    function renderReport() {
      const per = byId('lapPeriod').value || todayMonth();
      const st = byId('lapStatus').value || 'all';
      const data = bills.filter(b => b.periode === per && (st==='all' || b.status===st));
      const tb = byId('reportBody');
      const empty = byId('reportEmpty');
      tb.innerHTML = '';
      empty.style.display = data.length ? 'none' : 'block';
      data.forEach(b => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5';
        tr.innerHTML = `
          <td class="px-4 py-3">${new Date(b.createdAt).toLocaleString('id-ID')}</td>
          <td class="px-4 py-3">${escapeHTML(b.nama)}${b.idpel? ' • '+escapeHTML(b.idpel):''}</td>
          <td class="px-4 py-3">${b.periode.split('-').reverse().join('/')}</td>
          <td class="px-4 py-3 text-right">${rupiah(b.total)}</td>
          <td class="px-4 py-3 text-center">${b.status==='paid'?'Sudah Bayar':'Belum Bayar'}</td>
        `;
        tb.appendChild(tr);
      });
    }
    byId('lapPeriod').value = todayMonth();
    byId('lapStatus').addEventListener('change', renderReport);
    byId('lapPeriod').addEventListener('change', renderReport);
    byId('printBtn').addEventListener('click', () => window.print());
    byId('exportReportBtn').addEventListener('click', () => {
      const header = ['createdAt','nama','idpel','periode','total','status'];
      const per = byId('lapPeriod').value || todayMonth();
      const st = byId('lapStatus').value || 'all';
      const data = bills.filter(b => b.periode === per && (st==='all' || b.status===st));
      const csv = [header.join(',')].concat(data.map(b => header.map(h => csvCell(b[h])).join(','))).join('\n');
      downloadCSV(csv, 'cmmsc_laporan.csv');
    });

    // Public form (demo)
    const publicForm = byId('publicForm');
    publicForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const item = {
        id: crypto.randomUUID(),
        waktu: new Date().toISOString(),
        nama: byId('f_nama').value.trim(),
        wa: normPhone(byId('f_wa').value),
        alamat: byId('f_alamat').value.trim(),
        paket: (byId('f_paket').value === 'Custom' ? (byId('f_paket_custom').value.trim() || 'Custom') : byId('f_paket').value),
        mbps: Number(byId('f_mbps').value || 0),
        harga: Number(byId('f_harga').value || 0),
        tglAktif: byId('f_tgl_aktif').value
      };
      if (!item.nama || !item.wa || !item.mbps || !item.harga || !item.tglAktif) return alert('Lengkapi data.');
      forms.push(item); save(LS_FORMS, forms); renderForms();
      publicForm.reset();
    });
    function renderForms() {
      const body = byId('pendaftaranBody');
      const empty = byId('pendaftaranKosong');
      body.innerHTML = '';
      empty.style.display = forms.length ? 'none' : 'block';
      forms.forEach(f => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-white/5';
        tr.innerHTML = `
          <td class="px-4 py-3">${new Date(f.waktu).toLocaleString('id-ID')}</td>
          <td class="px-4 py-3">${escapeHTML(f.nama)}</td>
          <td class="px-4 py-3">${f.wa}</td>
          <td class="px-4 py-3">${escapeHTML(f.paket)} • ${f.mbps} Mbps</td>
        `;
        body.appendChild(tr);
      });
    }

    // CSV helpers
    function parseCSV(text) {
      const lines = text.split(/\r?\n/).filter(l => l.trim().length);
      if (!lines.length) return [];
      const headers = splitCsvLine(lines[0]).map(h => h.trim());
      return lines.slice(1).map(line => {
        const cells = splitCsvLine(line);
        const obj = {}; headers.forEach((h,i) => obj[h] = (cells[i]??'').trim());
        return obj;
      });
    }
    function splitCsvLine(line) {
      const out = []; let cur = ''; let inQ = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"') {
          if (inQ && line[i+1] === '"') { cur+='"'; i++; }
          else { inQ = !inQ; }
        } else if (ch === ',' && !inQ) { out.push(cur); cur=''; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }
    function csvCell(v) {
      if (v === null || v === undefined) return '';
      const s = String(v).replace(/"/g, '""');
      return /[",\n]/.test(s) ? `"${s}"` : s;
    }
    function downloadCSV(csv, name) {
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = name; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
    }

    // Initial renders
    syncHargaInput();
    renderPelanggan();
    renderBills();
    fillWaPeriodOptions();
    renderWAList();
    renderReport();
    renderForms();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'972366df360d8a9a',t:'MTc1NTcwODc1NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
